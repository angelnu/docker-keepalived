sudo: required

services:
 - docker

addons:
  apt:
    packages:
      - docker-ce=18.03* #Needed for experimental CLI (manifest)

language: bash

env:
  matrix:
  - DOCKER_ARCH=amd64
  - DOCKER_ARCH=arm64
  - DOCKER_ARCH=arm

script:
- if [ "x$TRAVIS_BRANCH" = "xmaster" ]; then export TAG="latest"; else export TAG="devel";fi
- BUILD=true PUSH=false TAG=$TAG ./build.sh
- |
  if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
    # Push image
    docker login -u="$DOCKER_USER" -p="$DOCKER_PASS"
    BUILD=false PUSH=true TAG=$TAG ./build.sh
  fi

jobs:
  include:

  - stage: Manifest
    script:
    - if [ "x$TRAVIS_BRANCH" = "xmaster" ]; then export TAG="latest"; else export TAG="devel";fi
    - |
      mkdir -p $HOME/.docker
      echo '{"experimental": "enabled"}'>$HOME/.docker/config.json
    - docker login -u="$DOCKER_USER" -p="$DOCKER_PASS"
    - |
      if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
        ARCHS="arm amd64 arm64" BUILD=false PUSH=false TAG=$TAG MANIFEST=true ./build.sh
      fi
    env:
